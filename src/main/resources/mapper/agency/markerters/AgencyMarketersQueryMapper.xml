<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.adplatform.restApi.agency.marketers.dao.mapper.AgencyMarketersQueryMapper">
    <resultMap id="mapMy" type="com.adplatform.restApi.agency.marketers.dto.AgencyMarketersDto$Response$MarketersDetail">
        <id column="id" property="id"/>
        <result column="loginId" property="loginId"/>
        <result column="name" property="name"/>
        <result column="companyName" property="companyName"/>
        <result column="status" property="status"/>
    </resultMap>

    <sql id="mySelectQuery">
        SELECT ui.user_no AS id, ui.user_id AS loginId, ui.user_name AS name, ui.active AS status, ci.name AS companyName
          FROM user_info ui, company_info ci
         WHERE ui.company_info_id = ci.id
           AND ui.active = 'Y'
           AND ui.company_info_id IN (
                  SELECT a.company_info_id FROM user_info a WHERE a.user_no = #{loginUserNo}
               )
           AND ci.company_type = 'AGENCY'
    </sql>

    <select id="my" resultMap="mapMy">
        <include refid="mySelectQuery"/>
    </select>

    <resultMap id="mapSearch" type="com.adplatform.restApi.agency.marketers.dto.AgencyMarketersDto$Response$Search">
        <id column="id" property="id"/>
        <result column="name" property="name"/>
    </resultMap>

    <sql id="searchSelectQuery">
        SELECT ad.id, ad.name
          FROM adaccount_info ad, adaccount_business_right_info br
         WHERE ad.id = br.adaccount_info_id
           AND br.start_date <![CDATA[ <= ]]> DATE_FORMAT(NOW(), '%Y%m%d')
           AND br.end_date <![CDATA[ >= ]]> DATE_FORMAT(NOW(), '%Y%m%d')
           AND ad.platform_type = #{request.platformType}
           AND request_user_no = #{request.userNo}
    </sql>

    <select id="search" resultMap="mapSearch">
        <include refid="searchSelectQuery"/>
    </select>

    <select id="countSearch" resultType="long">
        SELECT COUNT(*)
        FROM (<include refid="searchSelectQuery"/>) a
    </select>
</mapper>
